title: moz-os — phase_0017: uart payload ingestion (block header input)  

intent  
extend uart functionality to ingest external payloads. this phase allows the kernel to receive an 80‑byte block header via uart, store it in memory, and use it as input for the mining loop. deterministic ingestion ensures reproducible mining runs.  

this phase adds:  
- uart receive buffer (80 bytes)  
- routine to read block header from uart into buffer  
- integration with mining loop (replace static header with received one)  
- confirmation banner after payload ingestion  

no share submission yet.  
no networking.  

============================================================  
section 1 — workspace structure extension  
============================================================  

1. modify kernel/kernel.c to include uart payload ingestion routine.  
2. keep kernel/link.ld unchanged.  
3. keep boot/mbr.asm and boot/stage2.asm unchanged.  

============================================================  
section 2 — implement uart payload ingestion  
============================================================  

1. in kernel/kernel.c:  
   - define `uart_read_block(uint8_t* buf, size_t len)` to read len bytes from uart.  
   - allocate 80‑byte buffer for block header.  
   - call `uart_read_block(header, 80)` to ingest payload.  
   - integrate buffer into mining loop (use received header instead of static one).  

2. after ingestion, print banner (“kernel: block header received via uart”).  

============================================================  
section 3 — deterministic boot behavior  
============================================================  

1. bios loads mbr at 0x7c00.  
2. mbr prints banner, reads stage‑2 from lba 2 into 0x8000.  
3. mbr jumps to 0x8000.  
4. stage‑2 enables a20, loads gdt, enters protected mode, builds paging structures, enters long mode, loads kernel.img into 0x00100000, jumps to kernel.  
5. kernel initializes uart, waits for 80‑byte payload, ingests block header, prints confirmation banner, runs mining loop with received header, halts deterministically when toy solution found.  

============================================================  
section 4 — no other files modified  
============================================================  

- do not add share submission.  
- do not add networking.  
- only modify kernel to include uart payload ingestion.  

============================================================  
completion criteria  
============================================================  

- kernel/kernel.c compiles into kernel/kernel.img without errors.  
- boot/stage2.asm and boot/mbr.asm assemble without errors.  
- boot image runs in qemu with `-serial stdio`:  
  - prints “mbr: moz-os boot entry”  
  - prints “stage2: a20 line enabled”  
  - prints “stage2: gdt loaded”  
  - prints “stage2: entered protected mode”  
  - prints “stage2: paging structures initialized”  
  - prints “stage2: entered long mode”  
  - prints “stage2: kernel loaded at 0x00100000”  
  - prints “kernel: moz-os skeleton entry”  
  - prints “kernel: sha‑256 compression validated”  
  - prints “kernel: double sha‑256 validated”  
  - prints “kernel: midstate optimization active”  
  - prints “kernel: valid solution meets target”  
  - prints “kernel: uart initialized”  
  - prints “kernel: block header received via uart”  
  - halts deterministically when toy solution found.  
- all lint warnings and errors resolved.  

============================================================  
post completion chores  
============================================================  

1. rename the current phase file by adding a .complete to the end of the name. for example: phase_0017.txt would become phase_0017.txt.complete  
2. add all files and commit them to git using the following format for the comment.  
    - feat: phase 0017: uart payload ingestion (block header input)  
3. determine the next phase sequentially and execute it: phase_0018.txt  