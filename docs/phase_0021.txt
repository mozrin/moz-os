title: mozos — phase_0021: integrated control loop (dynamic header + target ingestion, mining, share submission)  

intent  
consolidate all prior functionality into a single, deterministic control loop. this phase ties together uart payload ingestion (block header + target), mining loop with midstate optimization, full 256‑bit target comparison, and uart share submission. the kernel now continuously cycles through external work units, mines, and reports solutions.  

this phase adds:  
- unified control loop in kernel  
- ingestion of both header (80 bytes) and target (32 bytes) via uart  
- mining with midstate optimization and dynamic target  
- share submission via uart (nonce + hash)  
- confirmation banner after each cycle (“kernel: integrated control loop complete”)  

============================================================  
section 1 — workspace structure extension  
============================================================  

1. modify kernel/kernel.c to unify payload ingestion, mining, and share submission into one loop.  
2. keep kernel/link.ld unchanged.  
3. keep boot/mbr.asm and boot/stage2.asm unchanged.  

============================================================  
section 2 — implement integrated control loop  
============================================================  

1. in kernel/kernel.c:  
   - define main loop:  
     - read 80‑byte header via uart.  
     - read 32‑byte target via uart.  
     - run mining loop with midstate optimization.  
     - compare hash ≤ target.  
     - if valid, format nonce+hash, submit via uart.  
     - print banner (“kernel: integrated control loop complete”).  
     - repeat deterministically.  

============================================================  
section 3 — deterministic boot behavior  
============================================================  

1. bios loads mbr at 0x7c00.  
2. mbr prints banner, reads stage‑2 from lba 2 into 0x8000.  
3. mbr jumps to 0x8000.  
4. stage‑2 enables a20, loads gdt, enters protected mode, builds paging structures, enters long mode, loads kernel.img into 0x00100000, jumps to kernel.  
5. kernel initializes uart, enters integrated control loop:  
   - ingests header + target  
   - mines until solution found  
   - submits share via uart  
   - prints confirmation banner  
   - repeats deterministically.  

============================================================  
section 4 — no other files modified  
============================================================  

- do not add networking stack.  
- do not add pool protocol.  
- only modify kernel to unify control loop.  

============================================================  
completion criteria  
============================================================  

- kernel/kernel.c compiles into kernel/kernel.img without errors.  
- boot/stage2.asm and boot/mbr.asm assemble without errors.  
- boot image runs in qemu with `-serial stdio`:  
  - prints all prior banners (mbr, stage2, kernel init, sha‑256, double sha‑256, midstate, target, uart init, payload ingestion, share submission, work loop).  
  - prints “kernel: integrated control loop complete” after each cycle.  
  - repeats deterministically for each new payload.  
- all lint warnings and errors resolved.  

============================================================  
post completion chores  
============================================================  

1. rename the current phase file by adding a .complete to the end of the name. for example: phase_0021.txt would become phase_0021.txt.complete  
2. add all files and commit them to git using the following format for the comment.  
    - feat: phase 0021: integrated control loop (dynamic header + target ingestion, mining, share submission)  
3. determine the next phase sequentially and execute it: phase_0022.txt  